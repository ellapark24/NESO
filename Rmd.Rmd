---
title: "Assignment 1"
author: "Ella Park, Rosie Crookes, Kieran Marguerie de Rotrou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Testing

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r data setup, warning = FALSE}
library(tidyverse)
data <- read_csv("20161213_uk_wind_solar_demand_temperature_SCS2.csv")

data <- data %>%
  mutate(
    Local_DateTime = dmy_hm(`Local Time`),
    Month = month(Local_DateTime),
    WeekdayNum = wday(Local_DateTime),
    Year = year(Local_DateTime),
    Date = as.Date(Local_DateTime),
    Hour = hour(Local_DateTime),  # Extract hour
    winter_year = ifelse(Month >= 11, Year, Year - 1),
    winter_start = as.Date(paste0(winter_year, "-11-01")),
    DSN = as.numeric(Date - winter_start)
  )

# --- TO calculation (avg temp 3–6pm) ---
TO_data <- data %>%
  filter(Hour >= 15 & Hour <= 18) %>%
  group_by(Date) %>%
  summarise(TO = mean(temp_merra1, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(Date)

# --- TE calculation (recursive) ---
TE_data <- TO_data %>%
  mutate(TE = NA_real_)

# Initial condition: 1 Nov 1991 = 11.37 °C
TE_data$TE[1] <- 11.37  

for (i in 2:nrow(TE_data)) {
  TE_data$TE[i] <- mean(c(TE_data$TO[i], TE_data$TE[i-1]), na.rm = TRUE)
}

# Join TO and TE back into main dataset
data <- data %>%
  select(-Hour) %>%
  left_join(TE_data, by = "Date")

# Define the months you want to keep
desired_months <- c(11, 12, 1, 2, 3)

# Filter rows where Month is in desired_months
filtered_data <- data[data$Month %in% desired_months & data$Year != 2015, ]

filtered_data <- filtered_data %>%
  group_by(Date) %>%
  summarise(
    across(where(is.numeric), mean, na.rm = TRUE)
  ) %>%
  ungroup()
```

```{r eda, echo = FALSE, warning=FALSE}
library(viridis)
library(gridExtra)
# Wind vs demand
wind_plot <- ggplot(filtered_data, aes(x=wind_merra1, y=demand_gross)) +
  geom_point(alpha=0.5, color=viridis(5)[4]) +
  geom_smooth(method="lm", color="red") +
  labs(title="Average Demand vs Wind Capacity", x="Wind Capacity Factor", y="Month Demand (MW)") +
  theme_bw()

# Solar vs demand
solar_plot <- ggplot(filtered_data, aes(x=solar_sarah, y=demand_gross)) +
  geom_point(alpha=0.5, color=viridis(5)[5]) +
  geom_smooth(method="lm", color="red") +
  labs(title="Month Demand vs Solar Capacity", x="Solar Capacity Factor", y="Month Demand (MW)") +
  theme_bw()

# Temp vs demand- shows negative correlation
temp_plot <- ggplot(filtered_data, aes(x=temp_merra1, y=demand_gross)) +
   geom_point(alpha=0.5, color=viridis(9)[8]) +
   geom_smooth(method="lm", color="red") +
   labs(title="Month Demand vs Temperature", x="Temperature (°C)", y="Month Demand (MW)") +
   theme_bw()

# TE vs demand- shows negative correlation
to_plot <- ggplot(filtered_data, aes(x=TO, y=demand_gross)) +
   geom_point(alpha=0.5, color=viridis(9)[4]) +
   geom_smooth(method="lm", color="red") +
   labs(title="Month Demand vs TE", x="Temperature (°C)", y="Month Demand (MW)") +
   theme_bw()

# Start_Year vs demand- shows negative correlation
year_plot <- ggplot(filtered_data, aes(x=Year, y=demand_gross)) +
   geom_point(alpha=0.5, color=viridis(5)[1]) +
   geom_smooth(method="lm", color="red") +
   labs(title="Month Demand vs Winter Start Year", x="Year", y="Month Demand (MW)") +
   theme_bw()
```

```{r demand_scatters_show, warning = FALSE, echo=FALSE, out.width="100%", cache = FALSE, caption = "Plotting Month demand against explanatory variables."}
suppressWarnings(grid.arrange(wind_plot, solar_plot, temp_plot, to_plot, year_plot, ncol = 2))
```

```{r violin, echo=FALSE, warning=FALSE}
library(gridExtra)
# Month vs demand
month_plot <- ggplot(filtered_data, aes(x=factor(Month, levels = c(11, 12, 1, 2, 3)), y=demand_gross, fill=factor(Month))) +
  geom_violin(alpha=0.5) +  # Create the violin plot
  geom_boxplot(width=0.2, color="black", alpha=0.7) +  # Add a boxplot inside the violin for quartiles
  scale_fill_viridis_d(option="viridis") +    
  scale_x_discrete(labels=c("November", "December", "Janurary", "February", "March")) +
  labs(title="Month Demand Distribution by Month", x="Month", y="Month Demand (MW)") +
  theme_bw() +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Day of week
day_plot <- ggplot(filtered_data, aes(x=factor(WeekdayNum), y=demand_gross, fill=factor(WeekdayNum))) +
  geom_violin(alpha=0.5) +  # Create the violin plot
  geom_boxplot(width=0.2, color="black", alpha=0.7) +  # Add a boxplot inside the violin for quartiles
  scale_fill_viridis_d(option="viridis") + 
  scale_x_discrete(labels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")) +
  labs(title="Month Demand by Day of the Week", x="Day of Week", y="Month Demand (MW)") +
  theme_bw() +
  guides(fill=FALSE) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r violin_show, warning = FALSE, echo=FALSE, out.width="100%", cache = FALSE, caption = "Violin plots to analyse effect of month and day on Month demand."}
grid.arrange(month_plot, day_plot, ncol = 2, nrow = 1)
```

```{r wday_eda_table, echo=FALSE, warning=FALSE}
weekdays_stats <- data.frame(
  Day = factor(0:6, labels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
  Median = tapply(filtered_data$demand_gross, filtered_data$WeekdayNum, median, na.rm = TRUE),
  Q1 = tapply(filtered_data$demand_gross, filtered_data$WeekdayNum, function(x) quantile(x, 0.25, na.rm = TRUE)),
  Q3 = tapply(filtered_data$demand_gross, filtered_data$WeekdayNum, function(x) quantile(x, 0.75, na.rm = TRUE))
)
print(weekdays_stats)
```